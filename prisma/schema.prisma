generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model ProjectAccess {
  accessId   String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("pac_accessid")
  userId     String    @db.Uuid @map("pac_userid")
  projectId  String    @db.Uuid @map("pac_projectid")
  role       String?   @db.VarChar(50) @map("pac_role")
  invitedAt  DateTime? @db.Timestamp(6) @map("pac_invited_at")
  accepted   Boolean?  @default(false) @map("pac_accepted")
  createdAt  DateTime? @default(now()) @db.Timestamp(6) @map("pac_created_at")
  roleId     String?   @db.Uuid @map("pac_role_id")
  updatedAt  DateTime? @db.Timestamp(6) @map("updated_at")
  project    Project   @relation(fields: [projectId], references: [id], onDelete: Cascade, onUpdate: NoAction)
  roleRef    Role?     @relation(fields: [roleId], references: [id], onUpdate: NoAction)
  user       User      @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([projectId], map: "idx_projectaccess_project")
  @@index([userId], map: "idx_projectaccess_user")
  @@map("projectaccess")
}

model Project {
  id               String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("proj_projid")
  name             String               @db.VarChar(255) @map("proj_name")
  dbNamespace      String               @unique @db.VarChar(255) @map("proj_db_namespace")
  createdBy        String?              @db.Uuid @map("proj_created_by")
  createdAt        DateTime?            @default(now()) @db.Timestamp(6) @map("proj_created_at")
  description      String?              @map("proj_description")
  updatedAt        DateTime?            @db.Timestamp(6) @map("updated_at")
  projectAccess    ProjectAccess[]
  accessAudits     ProjectAccessAudit[]
  creator          User?                @relation(fields: [createdBy], references: [id], onUpdate: NoAction)

  @@map("projects")
}

model Role {
  id            String          @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("role_roleid")
  name          String          @db.VarChar(100) @map("role_name")
  projectAccess ProjectAccess[]

  @@map("roles")
}

model Session {
  id                    String                   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("session_id")
  userId                String?                  @db.Uuid @map("user_id")
  refreshTokenHash      String?                  @map("refresh_token_hash")
  expiresAt             DateTime?                @db.Timestamp(6) @map("expires_at")
  lastSeenAt            DateTime?                @db.Timestamp(6) @map("last_seen_at")
  revoked               Boolean?                 @default(false)
  userAgent             String?                  @map("user_agent")
  ipAddress             String?                  @db.Inet @map("ip_address")
  createdAt             DateTime?                @default(now()) @db.Timestamp(6) @map("created_at")
  meta                  Json?
  refreshTokenBlacklist RefreshTokenBlacklist[]
  user                  User?                    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction, map: "sessions_userid_fkey")

  @@map("sessions")
}

model UserIdentity {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("identity_id")
  userId         String?   @db.Uuid @map("user_id")
  provider       String    @db.VarChar(100)
  providerUserId String    @db.VarChar(255) @map("provider_user_id")
  providerEmail  String?   @db.Citext @map("provider_email")
  createdAt      DateTime? @default(now()) @db.Timestamp(6) @map("created_at")
  emailVerified  Boolean?  @default(false) @map("email_verified")
  displayName    String?   @db.VarChar(255) @map("display_name")
  avatarUrl      String?   @map("avatar_url")
  user           User?     @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@unique([provider, providerUserId], map: "user_identities_provider_userid_key")
  @@map("user_identities")
}

/// This model contains an expression index which requires additional setup for migrations. Visit https://pris.ly/d/expression-indexes for more info.
model User {
  id             String               @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("user_userid")
  email          String               @unique @db.Citext @map("user_email")
  passwordHash   String               @db.VarChar(255) @map("user_password_hash")
  name           String?              @db.VarChar(100) @map("user_name")
  createdAt      DateTime?            @default(now()) @db.Timestamp(6) @map("user_created_at")
  emailVerified  Boolean?             @default(false) @map("user_email_verified")
  lastLogin      DateTime?            @db.Timestamp(6) @map("last_login")
  isActive       Boolean?             @default(true) @map("is_active")
  updatedAt      DateTime?            @db.Timestamp(6) @map("updated_at")
  projectAccess  ProjectAccess[]
  accessAudits   ProjectAccessAudit[]
  projects       Project[]
  sessions       Session[]
  userAudits     UserAudit[]
  identities     UserIdentity[]
  settings       UserSettings[]

  @@map("users")
}

model UserSettings {
  id                   String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("uset_settingsid")
  userId               String?  @db.Uuid @map("uset_userid")
  theme                String?  @db.VarChar(50) @map("uset_theme")
  language             String?  @db.VarChar(10) @map("uset_language")
  notificationsEnabled Boolean? @default(true) @map("uset_notifications_enabled")
  user                 User?    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("usersettings")
}

model ProjectAccessAudit {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("audit_id")
  accessId      String?   @db.Uuid @map("pac_accessid")
  projectId     String?   @db.Uuid @map("project_id")
  userId        String?   @db.Uuid @map("user_id")
  operation     String?   @db.VarChar(20)
  changedBy     String?   @db.Uuid @map("changed_by")
  changedAt     DateTime? @default(now()) @db.Timestamp(6) @map("changed_at")
  changedFields Json?     @map("changed_fields")
  old           Json?
  new           Json?
  project       Project?  @relation(fields: [projectId], references: [id], onUpdate: NoAction)
  user          User?     @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@index([projectId], map: "idx_pac_audit_project")
  @@index([userId], map: "idx_pac_audit_user")
  @@map("projectaccess_audit")
}

model RefreshTokenBlacklist {
  tokenHash     String    @id @map("token_hash")
  sessionId     String?   @db.Uuid @map("session_id")
  blacklistedAt DateTime? @default(now()) @db.Timestamp(6) @map("blacklisted_at")
  expiresAt     DateTime? @db.Timestamp(6) @map("expires_at")
  reason        String?
  session       Session?  @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@map("refresh_token_blacklist")
}

model UserAudit {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid @map("audit_id")
  userId        String?   @db.Uuid @map("user_id")
  operation     String?   @db.VarChar(20)
  changedBy     String?   @db.Uuid @map("changed_by")
  changedAt     DateTime? @default(now()) @db.Timestamp(6) @map("changed_at")
  changedFields Json?     @map("changed_fields")
  old           Json?
  new           Json?
  user          User?     @relation(fields: [userId], references: [id], onUpdate: NoAction)

  @@map("user_audit")
}
